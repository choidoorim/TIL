# 12-2. 동기화 기법

- 동기화를 도구에 뮤텍스 락, 세마포, 모니터가 있다.

## 뮤텍스 락

![Untitled](https://github.com/choidoorim/programing-books/assets/63203480/302366fe-be5a-473b-89c6-3ee0fcd5d143)

- 문의 자물쇠같은 기능을 코드로 구현한 것이 뮤텍스 락이다. 임계 구역에 자물쇠를 걸어두어, 다른 프로세스는 임계 구역이 잠겨있다면 기다리고, 잠겨 있지 않다면 임계 구역에 진입한다.
- 뮤텍스 락은 하나의 전역 변수와 두 개의 함수로 구현할 수 있다.

    ```
    lock;
    acquire();
    release();
    ```

- acquire 함수는 프로세스가 임계 구역에 진입하기 전에 호출하는 함수이다. 임계 구역이 잠겨 있다면 임계 구역이 열릴 때까지 임계 구역을 확인하고, 임계 구역이 열려 있다면 임계 구역을 잠그는 함수이다.
- release 함수는 임계 구역의 작업이 끝나고 호출하는 함수이다. 현재 임계 구역을 열어주는 함수이다.

```
lock;

acquire() {
	while(lock == true) { // 1
		//...
	}
	lock = true; // 2
}

release() {
	lock = false; // 3
}

1. 임계 구역이 잠겨있다면 임계 구역이 잠겨 있는지 반복적으로 확인한다.
2. 임계 구역이 잠겨 있지 않다면 임계 구역을 잠금한다.
3. 임계 구역 작업이 끝났으니 잠금을 해제한다.
```

- 임계 구역이 잠겨 있어 사용할 수 있는 자원이 없을 경우 프로세스는 무한정 기다리게 된다. 그리고 이것을 바쁜 대기라고 한다.

## 세마포

![Untitled2](https://github.com/choidoorim/programing-books/assets/63203480/9b8ac668-4979-4b89-819f-bd5ae883332b)

- 뮤텍스락과 비슷하지만 조금 더 일반화된 방식의 동기화 도구이다.
- 뮤텍스락은 하나만의 공유 자원에 접근하는 프로세스를 고려하고 만들었다. 즉, 문이 하나만 존재하는 것이다. 하지만 **공유 자원이 여러 개 있을 경우 여러 개의 프로세스가 각각 공유 자원에 접근이 가능**해야 하는데 세마포는 그런 것이 가능한 동기화 도구다.
- 신호등과 같이 건너도 되는 초록불, 건너면 안되는 빨간불 처럼 임계 구역에 들어가기 위해서는 멈춤 신호일 경우 기다리다가, 가도 된다는 신호를 받으면 임계 구역에 진입한다.
- 세마포도 뮤텍스락과 비슷하게 하나의 변수와 두 개의 함수로 구현할 수 있다.
    - 임계 구역에 진입할 수 있는 프로세스의 개수를 나타내는 전역 변수,
    - 임계 구역에 들어가야하는지 기다려야하는지 알려주는 함수인 wait 함수
    - 임계 구역 앞에서 기다리고 있는 프로세스에게 이제 들어가도 좋다고 알려주는 함수인 signal 함수

    ```
    S;
    
    wait() {
    	while(S <= 0) { // 1
    	}
    	S--; // 2
    }
    
    signal() {
      S++; // 3
    }
    
    1. 임계 구역 안에 진입할 수 있는 프로세스 개수가 0 이하라면 사용할 수 있는 자원이 있는지 반복적으로 확인한다.
    2. 임계 구역에 진입할 수 있는 프로세스 개수가 1 개 이상일 경우 S 를 1 감소시키고 임계 구역에 진입한다.
    3. 임계 구역 작업을 마친 뒤 S 를 1 증가시킨다.
    ```

- 뮤텍스락처럼 바쁜 대기가 발생하면 CPU 주기를 낭비하게 된다. 따라서 세마포는 사용할 수 있는 자원이 없을 경우 **프로세스를 대기 상태**로 만들고, 그 프로세의 PCB 를 세마포를 위한 대기 큐에 넣는다. 그리고 signal 함수를 호출하면 **대기 중이 프로세스를 제거**하고, **프로세스 상태를 준비 상태로 변경한 뒤에 준비 큐로 옮긴다**.

    ```
    wait() {
    	S--;
    	if ( S < 0 ) {
    		add this process to Queue;
    		sleep();
    	}
    }
    
    signal() {
      S++;
    	if ( S <= 0 ) {
    		remove a process p from Queue;
    		wakeup(p);
    	} 
    }
    ```

- 세마포를 이용하면 동시에 실행되는 프로세스의 실행 순서를 제어할 수 있는데 전역 변수 S 를 0 으로 두고, 먼저 실행할 프로세스 뒤에 signal 함수, 다음에 실행할 프로세스 앞에 wait 함수를 붙이면 P1 → P2 순서를 보장할 수 있다.

## 모니터

![Untitled3](https://github.com/choidoorim/programing-books/assets/63203480/3c762c79-cc05-4b01-9ee6-fe2c4504c137)

- 세마포는 사용자가 직접 wait, signal 함수를 명시하는 번거로운 작업을 해야한다. 모니터는 내부에서 상호 배제와 조건부 실행을 지원받을 수 있다. 
- 모니터는 공유 자원과 공유 자원에 접근하기 위한 인터페이스를 묶어서 관리한다. 프로세스는 인터페이스를 통해만 공유 자원에 접근할 수 있다. 모니터는 공유 자원을 다루는 인터페이스에 접근하기 위한 큐를 만들고, 큐에 삽입된 순서대로 하나씩 공유 자원을 이동하게하여 **모니터 안에서 항상 하나의 프로세스만 들어오도록 상호 배제를 위한 동기화를 제공**한다.
- 모니터도 세마포처럼 실행 순서 제어를 위한 동기화도 제공한다. 특정 조건으로 프로세스를 실행하고 일시 중지하기 위해 조건 변수를 사용한다. wait 는 호출한 프로세스의 상태를 대기 상태로 전환하고 일시적으로 조건 변수에 대한 대기 큐에 삽입한다.
  ![DIAGRAM-monitor-CV](https://github.com/choidoorim/programing-books/assets/63203480/d168b67c-5c73-407f-be49-f14b84467807)
  
  조건 변수에 대한 큐는 모니터에 진입하기 위해 삽입되는 큐가 아니라 **모니터에 이미 진입한 프로세스의 실행 조건이 만족될 때까지 잠시 실행이 중단되어 기다리기 위해 만들어진 큐**이다.
