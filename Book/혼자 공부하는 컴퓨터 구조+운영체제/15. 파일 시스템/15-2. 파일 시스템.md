# 15-2. 파일 시스템

## 파티셔닝과 포매팅

- 보조기억장치를 이용하기 위해서는 파티션을 나누는 작업과 포맷 작업을 거쳐야 한다.
- 파티셔닝은 저장 장치의 논리적인 영역을 나누는 방법이다. 예를 들면 하나의 서랍 안에 칸막이를 설치하는 것과 같다. 파티셔닝 작업을 통해 나누어진 영역을 파티션이라고 한다.
- 포매팅은 **파일 시스템을 설정하여 어떤 방식으로 파일을 저장하고 관리할 것인지를 결정**하고, 새로운 데이터를 쓸 준비를 하는 작업을 의미한다.
- 포매팅이 완료된 후에 파일 시스템이 결정되면 파일과 디렉터리 생성이 가능하다.

## 파일 할당 방법

- 운영체제는 파일과 디렉터리를 블록 단위로 읽고 쓴다.
- 하드디스크의 가장 작은 저장 단위는 섹터이지만, 운영체제는 하나 이상의 섹터를 블록이라는 단위로 묶은 뒤 블록 단위로 파일과 디렉터리를 관리한다. 그 이유는 파일 시스템이 모든 섹터를 관리하기에는 개수가 너무 많고 크기도 작기 때문이다.
- 파일을 보조기억장치에 할당하는 방법에는 연속 할당과 불연속 할당이 있으며, 불연속 할당에는 연결 할당과 색인 할당이 있다.

### 연속 할당(contiguous allocation)

- 보조기억장치 내 연속적인 블록에 파일을 할당하는 방식이다.

  ![Untitled](https://github.com/choidoorim/programing-books/assets/63203480/0032e790-4d1a-477a-adbe-2efafb98a605)

- 연속으로 할당된 파일에 접근하기 위해서는 파일의 첫 번째 블록 주소와 블록 단위의 길이만 알면 된다.
- 구현이 간단하지만, 외부 단편화를 야기한다는 단점이 존재한다. 즉, 초기에는 파일을 나열하여 할당하지만 중간에 삭제될 경우 블록의 크기에 따라 파일을 할당할 수 없는 공간이 생기게 된다.

### 연결 할당(linked allocation)

![Untitled2](https://github.com/choidoorim/programing-books/assets/63203480/17b14b16-afbe-4a06-9781-7dd34219484c)

- 각 블록에 다음 블록의 주소를 저장해서 각 블록이 다음 블록을 가리키는 형태로 할당하는 방식이다. 즉, 연결 리스트로 데이터들을 관리하는 것이다.
- 연결 할당의 첫 번째 단점은 파일의 중간 부분부터 접근하고 싶어도 반드시 파일의 첫 번째 블록부터 접근하여 차례대로 읽어야 한다는 단점이 있다. 즉, 파일의 임의 위치에 접근하는 속도인 임의 접근(random access) 속도가 느리다.
- 연결 할당의 두 번째 단점은 하드웨어의 고장이나 오류 발생 시 해당 블록 이후 블록은 접근할 수 없다는 단점이 있다.
- 연결 할당을 변형한 대표적인 파일 시스템이 있는데 오늘날까지도 많이 사용하는 FAT 파일 시스템이다.

### 색인 할당

![Untitled3](https://github.com/choidoorim/programing-books/assets/63203480/94484b16-2bd3-4dad-b1e9-54015e443819)

- 색인 할당은 파일의 모든 블록 주소를 색인 블록(index block)이라는 하나의 블록에 모아 관리하는 방식이다.
- 색인 할당을 사용하는 파일 시스템에서는 디렉터리 엔트리에 파일 이름과 더불어 색인 블록 주소를 명시한다.

## 파일 시스템 살펴보기

- 파일 시스템은 여러 가지가 있는데 그 중 FAT 파일 시스템과 유닉스 파일 시스템이라는 것이 있다.

### FAT(File Allocation Table) 파일 시스템

![Fat32_structure svg4](https://github.com/choidoorim/programing-books/assets/63203480/1b8f993c-7f92-4cc1-bc7b-870d94399379)

- 각 블록에 포함된 다음 블록의 주소들을 한 군데 모아 테이블 형태로 관리하여 연결 할당 방식의 단점을 부분 해소할 수 있다. 그리고 이러한 테이블을 파일 할당 테이블(FAT)이라고 한다.
- FAT 는 파티션의 앞부분에 만들어진다. FAT 는 하드 디스크 파티션의 시작 부분에 있지만, 실행하는 도중 FAT 가 메모리에 캐시될 수도 있다. 메모리에 적재되어 실행하면 임의 접근 성능이 개선된다.

    ```
    예약 영역 | FAT 영역 | 루트 디렉터리 영역 | 데이터 영역
    ```

- 파일 시스템에서의 디렉터리들은 아래와 같은 형식으로 블록에 저장된다.

    ```
    파일이름 | 확장자 | 속성 | 예약영역 | 생성시간 | 마지막 접근 시간 | 마지막 수정 시간 | 시작 블록 | 파일 크기
    ```


### 유닉스 파일 시스템

- 유닉스 파일 시스템은 색인 할당 기반이다. 유닉스 파일 시스템에서는 색인 블록을 i-node(index-node) 라고 부른다.
- i-node 에는 파일 속성 정보와 15 개의 블록 주소가 저장될 수 있다. 그리고 i-node 는 파티션 내 특정 영역에 모여 있다.

    ```
    예약 영역 | i-node 영역 | 데이터 영역
    ```

- i-node 크기는 15 개로 유한하다. 하지만 블록이 15개보다 많다면 하나의 i-node 에 파일의 데이터 블록을 모두 가리킬 수 없다. 따라서 아래와 같은 방법을 해결한다.
    1. 블록 주소 중 12 개는 직접 블록 주소를 저장한다. 파일 데이터가 저장된 블록을 직접 블록이라고 한다.
    2. 12개로 부족하다면 13 번째 주소에 단일 간접 블록 주소를 저장한다. 단일 간접 블록이란 파일 데이터가 저장된 블록이 아닌 파일 데이터를 저장한 블록 주소가 저장된 블록이다.
    3. 13 번째 주소로도 충분하지 않다면, 14 번째 주소에 이중 간접 블록 주소를 저장한다. 단일 간접 블록들의 주소를 저장하는 블록이 이중 간접 블록이다.
    4. 14 번째 주소로도 충분하지 않다면, 15 번째 주소에 삼중 간접 블록 주소를 저장한다. 삼중 간접 블록 주소는 이중 간접 블록 주소가 저장된 블록이다.


## 저널릭 파일 시스템

- 파일 시스템을 변경하는 도중에 치명적인 오류로 인해 컴퓨터가 강제로 종료되어 버린 상황(시스템 크래시)이 발생하면 파일 시스템이 훼손될 수 있다.
- 저널릭 파일 시스템이 생기기 전에는 시스템 크래시가 발생하면 부팅 직후 파일 시스템을 검사하고 복구하는 프로그램을 실행시켰다. 하지만 프로그램들이 파일 시스템 내의 모든 블록에 대해 파일 시스템을 검사하기 때문에 시간이 매우 오래걸렸다.
- **저널링 기법이란 작업 로그를 통해 시스템 크래시가 발생했을 때 빠르게 복구하기 위한 방법**이다.
    1. 작업 직전 파티션의 로그 영역에 수행하는 작업에 대한 로그를 남긴다.
    2. 로그를 남긴 후 작업을 수행한다.
    3. 작업이 끝나면 로그를 삭제한다.

    ```
    예약 영역 | 로그 영역 | i-node 영역 | 데이터 영역
    ```


## 마운트

- 마운트란 하나의 저장 장치의 파일 시스템에서 다른 저장 장치의 파일 시스템에 접근할 수 있도록 파일 시스템을 편입시키는 작업이다.
- 다양한 저장 장치를 컴퓨터에 연결할 때 mount 명령어로 마운트할 수 있다.
