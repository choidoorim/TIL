# 8-2. 다양한 입출력 방법

## 프로그램 입출력

- 프로그램 속 명령어로 입출력장치를 제어하는 방법이다.
- CPU 가 프로그램 속의 명령어를 실행하는 과정에서 입출력 명렁어를 만나면, CPU 는 입출력 장치에 연결된 **장치 컨트롤러와 상호작용**하며 입출력 작업을 수행한다.
- CPU 는 여러 장치들 안에 있는 레지스터들을 모두 알고 있기 어렵기 때문에, 메모리 맵 입출력과 고립형 입출력이라는 2 가지 방식을 사용한다.

### 메모리 맵 입출력

- **메모리에 접근하기 위한 주소 공간과 입출력 장치에 접근하기 위한 주소 공간을 하나의 주소공간으로 간주**하는 방법이다.
- 1,024 개의 주소를 표현할 수 있는 컴퓨터가 있다면 512 개는 메모리 주소, 512 개는 장치 컨트롤러의 레지스터를 표현하기 위해 사용하는 것이다. 따라서 메모리의 공간이 축소된다.
- 메모리에 접근하는 명령어와 입출력장치에 접근하는 명령어가 굳이 다를 필요가 없다.

### 고립형 입출력

- **메모리를 위한 주소 공간과 입출력 장치를 위한 주소공간을 분리**하는 방법이다.
- 메모리 주소 공간이 축소되지 않는다.
- 입출력 전용 명령어를 사용한다.

## 인터럽트 기반 입출력

- 인터럽트를 기반으로 한 입출력을 인터럽트 기반 입출력(Interrupt Driven I/O)이라고 한다.
- 입출력 장치에 의한 하드웨어 인터럽트는 입출력 장치가 아닌 장치 컨트롤러에 의해 발생한다. CPU 는 장치 컨트롤러에 입출력 작업을 명령하고, 장치 컨트롤러가 입출력장치를 제어하면서 입출력을 수행하는 동안 CPU 는 다른 일을 할 수 있다.
- 동시에 여러 입출력 장치에서 인터럽트가 발생하면 CPU 는 순차적으로만 해결할 수 없기 때문에 인터럽트 간의 우선순위를 고려하여 **우선순위가 높은 인터럽트 순서대로 여러 인터럽트를 처리**한다.
- **플래그 레지스터 속 인터럽트 비트가 활성화되어 있는 경우**나 **인터럽트 비트를 비활성화해도 무시할 수 없는 인터럽트인 NMI(Non Maskable Interrupt)가 발생**한 경우 CPU 는 우선순위가 높은 인터럽트부터 처리한다.
- 우선순위를 반영해서 **다중 인터럽트를 처리하는 방법** 중, 많은 컴퓨터에서는 **프로그래머블 인터럽트 컨트롤러(PIC: Programmable Interrupt Controller) 라는 하드웨어를 사용**한다. PIC 는 여러 장치 컨트롤러에서 보낸 하드웨어 인터럽트 요청들의 **우선순위를 판별한 뒤 CPU 에게 어떤 인터럽트를 처리해야할지 알려주는 장치**이다.

  ![Untitled](https://github.com/choidoorim/programing-books/assets/63203480/8f8a251a-a9f1-419c-b144-045e15d113b7)

- PIC 의 다중 인터럽트 처리 과정은 아래와 같다.
    1. PIC 가 장치 컨트롤러에서 인터럽트 요청 신호를 받는다.
    2. 우선순위 판별 후 CPU 에게 처리해야 할 인터럽트 요청 신호를 보낸다.
    3. CPU 가 PIC 에 인터럽트 확인 신호를 보낸다.
    4. PIC 가 데이터 버스를 통해 CPU 에 인터럽트 벡터를 보낸다.
    5. CPU 는 인터럽트 벡터를 통해 인터럽트 요청의 주체를 알게 되고, 해당 장치의 인터럽트 서비스 루틴을 실행한다.
- 일반적으로는 복잡한 장치들의 인터럽트를 관리하기 위해서 PIC 를 2 개 이상 계층적으로 구성한다.
- PIC 는 NMI 까지 우선순위를 판별하지 않는다. NMI 는 우선순위가 가장 높기 때문에 판별이 불필요하기 때문이다. 즉, 우선순위를 판별하는 것은 인터럽트 비트를 통해 막을 수 있는 하드웨어 인터럽트이다.

## DMA(Direct Memory Access) 입출력

![Untitled](https://github.com/choidoorim/programing-books/assets/63203480/8a4e8c22-2b68-44d6-9996-34915d609c7b)

- 프로그램 입출력과 인터럽트 기반 입출력의 공통점은  CPU 를 반드시 거친다는 것이다. 만약 하드 디스크 백업과 같은 작업을 할 경우 CPU 의 부담은 커질것이다.  DMA 입출력은 입출력장치나 메모리가 **CPU 를 거치지 않고 상호작용** 할 수 있다. 즉, 직접 메모리에 접근할 수 있는 입출력 기능이다.
- DMA 입출력을 하기 위해서는 시스템 버스에 연결된 DMA 컨트롤러가 있어야 한다.

### DMA 입출력 과정

- DMA 입출력 과정은 아래와 같다.
    1. CPU 는 DMA 컨트롤러에 입출력장치의 주소, 수행할 연산, 읽거나 쓸 메모리의 주소 등과 같은 정보를 통해 입출력 작업을 명령한다.
    2. DMA 컨트롤러는 CPU 대신 장치 컨트롤러와 상호작용하면서 입출력 작업을 수행한다. DMA 컨트롤러는 경우에 따라 직접 메모리에 접근하여 정보를 읽거나 쓰기도 한다.
    3. 입출력 작업이 끝나면 DMA 컨트롤러가 CPU 에게 인터럽트를 걸어서 작업이 끝났음을 알린다.
- DMA 입출력은 입출력 장치와 메모리 사이에 주고받을 데이터가 CPU 를 거치지 않는다. CPU 는 DMA 컨트롤러에게 입출력 작업을 명령하고, 인터럽트만 받는 것이다.
- 시스템 버스는 공용 자원이기 때문에 CPU 와 DMA 컨트롤러가 동시에 접근하여 사용하지 못한다. 따라서 DMA 컨트롤러는 CPU 가 시스템 버스를 이용하지 않을 때마다 조금씩 시스템 버스를 이용하거나, CPU 가 시스템 버스를 이용하지 않도록 허락을 받은 뒤 시스템 버스를 집중적으로 사용한다.

### 입출력 버스(i/o bus)

- DMA 때문에 시스템 버스를 너무 많이 사용한다면 CPU 가 시스템 버스를 이용하지 못하기 때문에 DMA 컨트롤러와 장치 컨트롤러들을 입출력 버스라는 별도의 버스에 연결하여 문제를 해결한다.
- DMA 컨트롤러와 장치 컨트롤러가 시스템 버스가 아닌 입출력 버스에 연결되어 서로 데이터를 전송할 때 시스템 버스를 이용할 필요가 없게 되므로 시스템 버스의 사용 빈도를 줄일 수 있다.
- 입출력 버스에는 PCI 버스, PCI Express(PCIe) 버스 등 여러 종류가 있다. 그리고 여러 입출력 장치들을 PCIe 버스와 연결해주는 통로를 PCIe 슬롯이라고 한다.
